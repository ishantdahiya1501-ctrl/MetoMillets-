document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".sidebar-nav a"),t=document.querySelectorAll(".page"),n=document.getElementById("pageTitle"),o=document.getElementById("productTableBody"),d=document.getElementById("productModal"),a=document.getElementById("closeModal"),i=document.getElementById("addProductBtn"),s=document.getElementById("productForm"),l=document.getElementById("modalTitle"),r=document.getElementById("undoContainer"),c=document.getElementById("orderTableBody"),u=document.getElementById("slidesTableBody"),m=document.getElementById("customerTableBody"),g=document.getElementById("orderDetailModal"),p=document.getElementById("closeOrderModal"),y=document.getElementById("updateStatusBtn"),E=document.getElementById("undoBtn"),f=document.getElementById("specialRequestsTableBody"),I=document.getElementById("specialRequestModal"),B=document.getElementById("closeSpecialRequestModal"),h=document.getElementById("updateSpecialRequestStatusBtn"),b=document.getElementById("slideModal"),v=document.getElementById("closeSlideModal"),w=document.getElementById("addSlideBtn"),L=document.getElementById("slideForm");let C=null,S=null;const x={dashboard:"Dashboard",products:"Products",orders:"Orders",specialRequests:"Special Requests",customers:"Customers",content:"Content",settings:"Settings"},T="meToMilletsSpecialRequests";

// Lightweight on-page debug overlay so you can see admin logs without opening devtools
(function(){ try{
    const dbg = document.createElement('div'); dbg.id = 'adminDebug'; dbg.style.cssText = 'position:fixed;right:12px;bottom:12px;max-width:320px;max-height:240px;overflow:auto;background:rgba(0,0,0,0.8);color:#fff;padding:8px;border-radius:8px;font-size:12px;z-index:99999;pointer-events:auto;';
    dbg.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><strong style="font-size:13px">Admin Logs</strong><button id="adminDebugClose" style="background:#fff;border:none;padding:3px 6px;border-radius:4px;cursor:pointer">Ã—</button></div>';
    const content = document.createElement('div'); content.id = 'adminDebugContent'; dbg.appendChild(content);
    document.body && document.body.appendChild(dbg);
    document.getElementById('adminDebugClose')?.addEventListener('click', ()=>{ dbg.style.display = 'none'; });
    window.adminLog = function(msg){ try{ console.debug('[admin]', msg); const p = document.createElement('div'); p.textContent = String(msg); p.style.padding = '3px 0'; p.style.borderTop = '1px solid rgba(255,255,255,0.06)'; content.appendChild(p); if(content.childNodes.length > 12) content.removeChild(content.childNodes[0]); }catch(e){} };
} catch(e){ /* ignore overlay errors */ } })();

// Centralized page switcher to ensure consistent behavior across click, keyboard and delegation
function showPage(pageId){
    console.debug('[admin] showPage called ->', pageId);
    if(!pageId) return;
    t.forEach(el=>{ el.style.display = 'none'; });
    const pageEl = document.getElementById(pageId);
    if(pageEl){ pageEl.style.display = 'block'; n.textContent = x[pageId] || pageId.charAt(0).toUpperCase()+pageId.slice(1); }
    switch(pageId){
        case "dashboard": $(); break;
        case "products": H(); break;
        case "orders": fetchOrdersFromAPI(); break;
        case "specialRequests": A(); break;
        case "customers": k(); break;
        case "content": F(); break;
        // settings or others do nothing special
    }
}

function statusDisplay(s){
    const map = { sent: 'Pending', pending: 'Pending', processing: 'Processing', delivered: 'Delivered' };
    return map[String(s||'')?.toLowerCase()] || String(s||'');
}async function $(){
    // Try to fetch orders from API and compute dashboard stats; fallback to localStorage
    try{
        if(window.mtmApi && typeof window.mtmApi.request === 'function'){
            const res = await window.mtmApi.request('GET','/api/orders');
            const orders = Array.isArray(res?.orders) ? res.orders : [];
            const revenue = orders.reduce((s,o)=>s + (Number(o.total)||0),0);
            const ordersCount = orders.length;
            const customers = {};
            orders.forEach(o=>{ const email = o.customer?.email || ''; if(email) customers[email] = true; });
            const uniqueCustomers = Object.keys(customers).length;
            const avg = ordersCount>0 ? revenue / ordersCount : 0;
            document.getElementById("dashboardTotalRevenue").textContent = `â‚¹${revenue.toFixed(2)}`;
            document.getElementById("dashboardTotalOrders").textContent = ordersCount;
            document.getElementById("dashboardTotalCustomers").textContent = uniqueCustomers;
            document.getElementById("dashboardAvgOrderValue").textContent = `â‚¹${avg.toFixed(2)}`;
            return;
        }
    }catch(err){
        console.warn('Failed to load dashboard stats from API, falling back to localStorage', err);
    }

    const e = window.utils.loadFromLocalStorage("orders")||[],t={};let n=0;e.forEach(e=>{n+=e.total;const o=e.customer.email;t[o]||(t[o]=!0)});const o=e.length,d=Object.keys(t).length,a=o>0?n/o:0;document.getElementById("dashboardTotalRevenue").textContent=`â‚¹${n.toFixed(2)}`,document.getElementById("dashboardTotalOrders").textContent=o,document.getElementById("dashboardTotalCustomers").textContent=d,document.getElementById("dashboardAvgOrderValue").textContent=`â‚¹${a.toFixed(2)}`
}function D(){if(!c)return;const e=window.utils.loadFromLocalStorage("orders")||[];c.innerHTML="",0!==e.length?e.reverse().forEach(e=>{const t=document.createElement("tr"),n=statusDisplay(e.status);t.innerHTML=`\n                <td><strong>${e.id}</strong></td>\n                <td>${e.customer.fullName}</td>\n                <td>${new Date(e.createdAt).toLocaleDateString()}</td>\n                <td>â‚¹${e.total.toFixed(2)}</td>\n                <td><span class="order-status status-${n.toLowerCase()}">${n}</span></td>\n                <td>\n                    <button class="action-btn edit" data-id="${e.id}" title="View Details">\n                        <i class="fas fa-eye"></i>\n                    </button>\n                    <button class="action-btn delete" data-id="${e.id}" title="Delete Order">\n                        <i class="fas fa-trash"></i>\n                    </button>\n                </td>\n            `,c.appendChild(t)}):c.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 2rem;">No orders found.</td></tr>'}

async function fetchOrdersFromAPI(){
    if(!c) return;
    c.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">Loading ordersâ€¦</td></tr>'; 
    try{
        if(window.mtmApi && typeof window.mtmApi.request === 'function'){
            const res = await window.mtmApi.request('GET','/api/orders');
            const orders = Array.isArray(res?.orders) ? res.orders : [];
            if(orders.length === 0){
                c.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No orders found.</td></tr>';
                return;
            }
            c.innerHTML = '';
            orders.forEach(e => {
                const t = document.createElement('tr');
                const statusLabel = statusDisplay(e.status);
                t.innerHTML = `\n                <td><strong>${e.id}</strong></td>\n                <td>${e.customer?.fullName || (e.customer && e.customer.name) || 'Unknown'}</td>\n                <td>${new Date(e.createdAt).toLocaleDateString()}</td>\n                <td>â‚¹${(Number(e.total)||0).toFixed(2)}</td>\n                <td><span class=\"order-status status-${String(statusLabel).toLowerCase()}\">${statusLabel}</span></td>\n                <td>\n                    <button class=\"action-btn edit\" data-id=\"${e.id}\" title=\"View Details\">\n                        <i class=\"fas fa-eye\"></i>\n                    </button>\n                    <button class=\"action-btn delete\" data-id=\"${e.id}\" title=\"Delete Order\">\n                        <i class=\"fas fa-trash\"></i>\n                    </button>\n                </td>\n            `;
                c.appendChild(t);
            });
            return;
        }
    }catch(err){
        console.warn('Failed to load orders from API, falling back to localStorage', err);
    }
    D();
}function k(){if(!m)return;const e=window.utils.loadFromLocalStorage("orders")||[],t={};e.forEach(e=>{const n=e.customer.email;t[n]||(t[n]={name:e.customer.fullName,email:n,phone:e.customer.phone||"N/A",orderCount:0,totalSpent:0}),t[n].orderCount++,t[n].totalSpent+=e.total});const n=Object.values(t);m.innerHTML="",0!==n.length?n.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                <td><strong>${e.name}</strong></td>\n                <td>${e.email}</td>\n                <td>${e.phone}</td>\n                <td>${e.orderCount}</td>\n                <td>â‚¹${e.totalSpent.toFixed(2)}</td>\n                <td>\n                    <button class="action-btn delete" data-email="${e.email}" title="Anonymize Customer">\n                        <i class="fas fa-user-slash"></i>\n                    </button>\n                </td>\n            `,m.appendChild(t)}):m.innerHTML='<tr><td colspan="6" style="text-align:center; padding: 2rem;">No customers found.</td></tr>'}function M(){const e=window.utils.loadFromLocalStorage(T)||[];return Array.isArray(e)?e:[]}function N(e){window.utils.saveToLocalStorage(T,e)}function A(){if(!f)return;const e=M();f.innerHTML="",0!==e.length?e.slice().sort((e,t)=>new Date(t.createdAt||0)-new Date(e.createdAt||0)).forEach(e=>{const t=document.createElement("tr"),n=e.status||"New";t.innerHTML=`\n                    <td><strong>${e.id||""}</strong></td>\n                    <td>${e.name||""}</td>\n                    <td>${e.eventType||""}</td>\n                    <td>${e.eventDate||""}</td>\n                    <td>${Number.isFinite(e.quantity)?e.quantity:e.quantity||""}</td>\n                    <td><span class="order-status status-${String(n).toLowerCase()}">${n}</span></td>\n                    <td>\n                        <button class="action-btn edit" data-id="${e.id}" title="View Details"><i class="fas fa-eye"></i></button>\n                        <button class="action-btn delete" data-id="${e.id}" title="Delete Request"><i class="fas fa-trash"></i></button>\n                    </td>\n                `,f.appendChild(t)}):f.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 2rem;">No special requests found.</td></tr>'}function q(){const e=window.utils.loadFromLocalStorage("heroSlides");return e&&e.length>0?e:[{id:1,type:"featured",title:"Pure Chocolate Joy",subtitle:"100% Processed-Free Sugar",description:"Indulge in our premium dark chocolates sweetened naturally with honey & dates. Zero preservatives, zero artificial flavors, 100% guilt-free pleasure.",image:"https://images.unsplash.com/photo-1575377427642-087cf684f29d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",buttonText:"Shop Now",buttonLink:"pages/products.html",badge:"ðŸ« Featured"},{id:2,type:"health",title:"Healthy Indulgence",subtitle:"Dark Chocolate is Heart-Healthy",description:"Rich in antioxidants and flavonoids, our chocolate supports heart health and boosts mood. Natural sweeteners mean no sugar crashesâ€”just pure, sustained energy and joy.",image:"https://images.unsplash.com/photo-1599599810694-b5ac4dd27068?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",buttonText:"Learn More",buttonLink:"#",badge:"â¤ï¸ Health Benefits"},{id:3,type:"millets",title:"Nutritious Millets",subtitle:"Ancient Grains, Modern Taste",description:"Millets add fiber, minerals, and a nutty depth to every bite. These ancient supergrains are gluten-free and packed with nutrients that fuel your body naturally.",image:"https://images.unsplash.com/photo-1599599810771-4f2b7b0abda3?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",buttonText:"Explore Flavors",buttonLink:"pages/products.html",badge:"ðŸŒ¾ Superfood"},{id:4,type:"upcoming",title:"Coming Soon",subtitle:"Limited Edition: Spiced Chai Chocolate",description:"Get ready for our most exotic flavor yet. Warming spices meet rich cacao in a celebration of chai traditions. Pre-order now and be the first to indulge.",image:"https://images.unsplash.com/photo-1599599810988-cf49c3b1f5f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",buttonText:"Pre-Order",buttonLink:"#",badge:"âœ¨ Coming Soon"},{id:5,type:"ethical",title:"Ethical Choice",subtitle:"Sourced with Purpose",description:"Every bar supports fair-trade farmers and sustainable cocoa practices. When you choose Me to Millets, you are choosing a better future for our planet and its people.",image:"https://images.unsplash.com/photo-1599599810753-86f0c2e7c8b9?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",buttonText:"Our Story",buttonLink:"pages/about.html",badge:"ðŸŒ Ethical"}]}function P(e){window.utils.saveToLocalStorage("heroSlides",e)}function F(){if(!u)return;const e=q();u.innerHTML="",e.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                <td>${e.badge}</td>\n                <td>${e.title}</td>\n                <td>\n                    <button class="action-btn edit" data-id="${e.id}" title="Edit Slide"><i class="fas fa-edit"></i></button>\n                    <button class="action-btn delete" data-id="${e.id}" title="Delete Slide"><i class="fas fa-trash"></i></button>\n                </td>\n            `,u.appendChild(t)})}function H(){if(!window.productData||!window.productData.products)return void console.error("Product data not found!");if(!o)return;const e=Array.isArray(window.productData.products)?window.productData.products:[];o.innerHTML="",0!==e.length?e.forEach(e=>{const t=Number(e.price),n=document.createElement("tr");n.innerHTML=`\n                <td>${e.id}</td>\n                <td>${e.name}</td>\n                <td>${e.category}</td>\n                <td>â‚¹${Number.isFinite(t)?t.toFixed(2):"0.00"}</td>\n                <td>\n                    <button class="action-btn edit" data-id="${e.id}">Edit</button>\n                    <button class="action-btn delete" data-id="${e.id}">Delete</button>\n                </td>\n            `,o.appendChild(n)}):o.innerHTML='<tr><td colspan="5" style="text-align:center; padding: 2rem;">No products found.</td></tr>'}function O(){localStorage.setItem("meToMilletsProducts",JSON.stringify(window.productData.products))}function R(){d.style.display="block"}function j(){d.style.display="none"}function W(){r.style.display="none",C=null}u&&u.addEventListener("click",e=>{const t=e.target.closest(".action-btn");if(!t)return;const n=parseInt(t.dataset.id);let o=q();if(t.classList.contains("edit")){const e=o.find(e=>e.id===n);e&&(document.getElementById("slideModalTitle").textContent="Edit Slide",document.getElementById("slideId").value=e.id,document.getElementById("slideBadge").value=e.badge,document.getElementById("slideTitle").value=e.title,document.getElementById("slideSubtitle").value=e.subtitle,document.getElementById("slideDescription").value=e.description,document.getElementById("slideImage").value=e.image,document.getElementById("slideButtonText").value=e.buttonText,document.getElementById("slideButtonLink").value=e.buttonLink,b.style.display="block")}t.classList.contains("delete")&&confirm(`Are you sure you want to delete the slide titled "${o.find(e=>e.id===n).title}"?`)&&(P(o.filter(e=>e.id!==n)),F(),window.utils.showNotification("Slide deleted successfully.","success"))}),w&&w.addEventListener("click",()=>{document.getElementById("slideModalTitle").textContent="Add New Slide",L.reset(),document.getElementById("slideId").value="",b.style.display="block"}),v&&v.addEventListener("click",()=>{b.style.display="none"}),L&&L.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("slideId").value;let n=q();const o={badge:document.getElementById("slideBadge").value,title:document.getElementById("slideTitle").value,subtitle:document.getElementById("slideSubtitle").value,description:document.getElementById("slideDescription").value,image:document.getElementById("slideImage").value,buttonText:document.getElementById("slideButtonText").value,buttonLink:document.getElementById("slideButtonLink").value};if(t){const e=n.findIndex(e=>e.id==t);e>-1&&(n[e]={...n[e],...o})}else{const e=n.length>0?Math.max(...n.map(e=>e.id))+1:1;n.push({id:e,...o})}P(n),F(),b.style.display="none",window.utils.showNotification("Hero slide saved successfully!","success")}),E.addEventListener("click",()=>{C&&(window.productData.products.splice(C.index,0,C.product),O(),H(),W())}),c&&c.addEventListener("click",async e=>{const t=e.target.closest(".action-btn");if(!t)return;const id=t.dataset.id; if(t.classList.contains("edit")){let order=null;try{if(window.mtmApi && typeof window.mtmApi.request === 'function'){const res = await window.mtmApi.request('GET','/api/orders');const orders = Array.isArray(res?.orders) ? res.orders : [];order = orders.find(o=>String(o.id)===String(id));}}catch(err){console.warn('Failed to fetch order from API',err);}if(!order){const o=window.utils.loadFromLocalStorage("orders")||[];order=o.find(o=>o.id===id);}if(order){document.getElementById("orderModalTitle").textContent=`Order Details: ${order.id}`,document.getElementById("orderCustomerName").textContent=order.customer?.fullName||order.customer?.name||'Unknown',document.getElementById("orderCustomerEmail").textContent=order.customer?.email||'N/A',document.getElementById("orderCustomerPhone").textContent=order.customer?.phone||"N/A",document.getElementById("orderShippingAddress").textContent=order.customer?.shippingAddress||"No address provided.",document.getElementById("orderTotal").textContent=`â‚¹${(Number(order.total)||0).toFixed(2)}`;const itemsT=document.getElementById("orderItemsTableBody");itemsT.innerHTML="",(order.items||[]).forEach(it=>{const tr=document.createElement("tr");tr.innerHTML=`\n                        <td>${it.name}</td>\n                        <td>${it.quantity}</td>\n                        <td>â‚¹${(it.price||0).toFixed(2)}</td>\n                        <td>â‚¹${((it.quantity||0)*(it.price||0)).toFixed(2)}</td>\n                    `,itemsT.appendChild(tr)}),document.getElementById("orderStatusSelect").value = statusDisplay(order.status),y.dataset.orderId=order.id,g.style.display="block"}}if(t.classList.contains("delete")&&confirm(`Are you sure you want to permanently delete Order ID: ${id}? This action cannot be undone.`)){try{if(window.mtmApi && typeof window.mtmApi.request === 'function'){await window.mtmApi.request('DELETE',`/api/orders/${id}`);await fetchOrdersFromAPI();window.utils.showNotification(`Order ${id} has been deleted.`,"success");return;}}catch(err){console.warn('Failed to delete order via API, falling back to localStorage',err);}const local=window.utils.loadFromLocalStorage("orders")||[];const filtered=local.filter(e=>e.id!==id);window.utils.saveToLocalStorage("orders",filtered),D(),window.utils.showNotification(`Order ${id} has been deleted.`,"success")} }),f&&f.addEventListener("click",e=>{const t=e.target.closest(".action-btn");if(!t)return;const n=t.dataset.id,o=M(),d=o.find(e=>e.id===n);if(t.classList.contains("edit")){if(!d||!I)return;document.getElementById("specialRequestModalTitle").textContent=`Special Request: ${d.id}`,document.getElementById("srCustomerName").textContent=d.name||"",document.getElementById("srCustomerEmail").textContent=d.email||"",document.getElementById("srCustomerPhone").textContent=d.phone||"N/A",document.getElementById("srEventType").textContent=`Event: ${d.eventType||""}`,document.getElementById("srEventDate").textContent=`Date Needed: ${d.eventDate||""}`,document.getElementById("srQuantity").textContent=`Quantity: ${d.quantity||""}`,document.getElementById("srBudget").textContent=`Budget/Unit: ${d.budget||"N/A"}`,document.getElementById("srFlavors").textContent=`Flavors: ${d.flavors||"N/A"}`;const e=Array.isArray(d.dietary)&&d.dietary.length?d.dietary.join(", "):"N/A";document.getElementById("srDietary").textContent=`Dietary: ${e}`,document.getElementById("srPackaging").textContent=`Packaging: ${d.packaging||"N/A"}`,document.getElementById("srDetails").textContent=`Details: ${d.details||""}`;const t=document.getElementById("specialRequestStatusSelect");t&&(t.value=d.status||"New"),h&&(h.dataset.requestId=d.id),I.style.display="block"}if(t.classList.contains("delete")){if(!n)return;confirm(`Are you sure you want to permanently delete request: ${n}? This action cannot be undone.`)&&(N(o.filter(e=>e.id!==n)),A(),window.utils.showNotification(`Request ${n} deleted.`,"success"))}});const z=document.getElementById("logoutBtn");z&&z.addEventListener("click",e=>{e.preventDefault(),sessionStorage.removeItem("isAdminAuthenticated"),alert("You have been logged out."),window.location.href="login.html"}),i&&i.addEventListener("click",()=>{l.textContent="Add New Product",s.reset(),document.getElementById("productId").value="",R()}),a&&a.addEventListener("click",j),p&&p.addEventListener("click",()=>{g.style.display="none"}),B&&B.addEventListener("click",()=>{I&&(I.style.display="none")}),h&&h.addEventListener("click",()=>{const e=h.dataset.requestId,t=document.getElementById("specialRequestStatusSelect")?.value||"New",n=M(),o=n.findIndex(t=>t.id===e);o>-1&&(n[o].status=t,N(n),A(),I&&(I.style.display="none"),window.utils.showNotification(`Request ${e} updated to ${t}.`,"success"))}),y&&y.addEventListener("click",async ()=>{const e=y.dataset.orderId,t=document.getElementById("orderStatusSelect").value;const normalized = t === 'Pending' ? 'pending' : t.toLowerCase();try{if(window.mtmApi && typeof window.mtmApi.request === 'function'){await window.mtmApi.request('PUT',`/api/orders/${e}`,{status:normalized});await fetchOrdersFromAPI();g.style.display="none";window.utils.showNotification(`Order ${e} status updated to ${t}.`,"success");return;}}catch(err){console.warn('Failed to update order via API, falling back to localStorage',err);}const n=window.utils.loadFromLocalStorage("orders")||[],o=n.findIndex(t=>t.id===e);o>-1&&(n[o].status=normalized,window.utils.saveToLocalStorage("orders",n),D(),g.style.display="none",window.utils.showNotification(`Order ${e} status updated to ${t}.`,"success"))}),window.addEventListener("click",e=>{e.target===d&&j(),e.target===g&&(g.style.display="none"),e.target===b&&(b.style.display="none"),e.target===I&&(I.style.display="none")}),

// Attach refresh button handler (if present)
const refreshBtn = document.getElementById("refreshOrdersBtn");
refreshBtn && refreshBtn.addEventListener("click", async () => {
    refreshBtn.disabled = true;
    const prev = refreshBtn.textContent;
    refreshBtn.textContent = 'Refreshing...';
    try{
        await fetchOrdersFromAPI();
        window.utils.showNotification('Orders refreshed.','success');
    }catch(err){
        console.warn('Refresh failed', err);
        window.utils.showNotification('Failed to refresh orders.','error');
    }finally{
        refreshBtn.disabled = false;
        refreshBtn.textContent = prev || 'Refresh';
    }
});

s&&s.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("productId").value;if(t){const e=window.productData.products.findIndex(e=>e.id==t);if(e>-1){const t=window.productData.products[e];t.name=document.getElementById("productName").value,t.category=document.getElementById("productCategory").value,t.price=parseFloat(document.getElementById("productPrice").value),t.image=document.getElementById("productImage").value,t.cocoaPercentage=parseInt(document.getElementById("cocoaPercentage").value)||0,t.subcategory=document.getElementById("subcategory").value,t.origin=document.getElementById("origin").value,t.description=document.getElementById("productDescription").value,t.ingredients=document.getElementById("ingredients").value.split(",").map(e=>e.trim()).filter(Boolean),t.allergens=document.getElementById("allergens").value.split(",").map(e=>e.trim()).filter(Boolean),t.pairing=document.getElementById("pairing").value.split(",").map(e=>e.trim()).filter(Boolean),t.featured=document.getElementById("featured").checked,t.limited=document.getElementById("limited").checked,t.temperatureWarning=document.getElementById("temperatureWarning").checked}}else{const e={id:window.productData.products.length>0?Math.max(...window.productData.products.map(e=>e.id))+1:1,name:document.getElementById("productName").value,category:document.getElementById("productCategory").value,price:parseFloat(document.getElementById("productPrice").value),image:document.getElementById("productImage").value,cocoaPercentage:parseInt(document.getElementById("cocoaPercentage").value)||0,subcategory:document.getElementById("subcategory").value,origin:document.getElementById("origin").value,description:document.getElementById("productDescription").value,ingredients:document.getElementById("ingredients").value.split(",").map(e=>e.trim()).filter(Boolean),allergens:document.getElementById("allergens").value.split(",").map(e=>e.trim()).filter(Boolean),pairing:document.getElementById("pairing").value.split(",").map(e=>e.trim()).filter(Boolean),rating:{rate:0,count:0},reviews:0,featured:document.getElementById("featured").checked,limited:document.getElementById("limited").checked,temperatureWarning:document.getElementById("temperatureWarning").checked};window.productData.products.push(e)}O(),H(),j()}),o&&o.addEventListener("click",e=>{const t=e.target;if(!t.classList.contains("action-btn"))return;const n=t.dataset.id;if(t.classList.contains("edit")){const e=window.productData.products.find(e=>e.id==n);e&&(l.textContent=`Edit Product (ID: ${e.id})`,document.getElementById("productId").value=e.id,document.getElementById("productName").value=e.name,document.getElementById("productCategory").value=e.category,document.getElementById("productPrice").value=e.price,document.getElementById("productImage").value=e.image||"",document.getElementById("cocoaPercentage").value=e.cocoaPercentage||"",document.getElementById("subcategory").value=e.subcategory||"",document.getElementById("origin").value=e.origin||"",document.getElementById("productDescription").value=e.description||"",document.getElementById("ingredients").value=(e.ingredients||[]).join(", "),document.getElementById("allergens").value=(e.allergens||[]).join(", "),document.getElementById("pairing").value=(e.pairing||[]).join(", "),document.getElementById("featured").checked=e.featured||!1,document.getElementById("limited").checked=e.limited||!1,document.getElementById("temperatureWarning").checked=!1!==e.temperatureWarning,R())}else if(t.classList.contains("delete")&&confirm(`Are you sure you want to delete product ID: ${n}?`)){const e=window.productData.products.findIndex(e=>e.id==n);if(e>-1){const t=window.productData.products[e];C=o={product:t,index:e},document.getElementById("undoMessage").textContent=`Deleted "${o.product.name}".`,r.style.display="flex",clearTimeout(S),S=setTimeout(()=>{W()},5e3),window.productData.products.splice(e,1),O(),H()}}var o}),m&&m.addEventListener("click",e=>{const t=e.target.closest(".action-btn");if(!t||!t.classList.contains("delete"))return;const n=t.dataset.email;if(confirm(`Are you sure you want to anonymize customer "${n}"? This will remove their personal data from all associated orders and cannot be undone.`)){let e=window.utils.loadFromLocalStorage("orders")||[];e.forEach(e=>{e.customer.email===n&&(e.customer={fullName:"Deleted Customer",email:`anonymized_${Date.now()}@deleted.com`,phone:"N/A",shippingAddress:"N/A"})}),window.utils.saveToLocalStorage("orders",e),k(),window.utils.showNotification(`Customer ${n} has been anonymized.`,"success")}}),e.forEach(link=>{const activatePage = (ev, srcLink) => { ev && ev.preventDefault && ev.preventDefault(); const target = srcLink || link; const page = target.getAttribute('data-page'); console.debug('[admin] activatePage ->', page, ev && ev.type); const prevActive = document.querySelector('.sidebar-nav li.active'); if(prevActive && prevActive.classList) prevActive.classList.remove('active'); if(target.parentElement && target.parentElement.classList) target.parentElement.classList.add('active'); showPage(page); };
            link.addEventListener('click', activatePage);
            // keyboard activation (Enter or Space) and touch support
            link.setAttribute('tabindex', '0');
            link.addEventListener("keydown",(ev)=>{ if(ev.key==="Enter" || ev.key===" " || ev.key==="Spacebar" || ev.code==="Space") { ev.preventDefault(); activatePage(ev); } });
            // Support touch (pointer events) â€” only trigger for touch pointers to avoid double-activation
            link.addEventListener('pointerdown', (ev) => { if (ev && ev.pointerType === 'touch') { ev.preventDefault(); activatePage(ev); } });

        // Delegated click handler to ensure clicks on child elements also activate the page
        const sidebarEl = document.querySelector('.sidebar-nav');
        if(sidebarEl){
            sidebarEl.addEventListener('click', (ev) => {
                const a = ev.target.closest && ev.target.closest('a[data-page]');
                if(a){ console.debug('[admin] delegated click ->', a.getAttribute('data-page'), ev.type);
                    const prevActive=document.querySelector('.sidebar-nav li.active'); if(prevActive) prevActive.classList.remove('active'); if(a.parentElement) a.parentElement.classList.add('active'); showPage(a.getAttribute('data-page')); }
            });
            sidebarEl.addEventListener('pointerup', (ev) => { if(ev.pointerType === 'touch'){ const a = ev.target.closest && ev.target.closest('a[data-page]'); if(a){ console.debug('[admin] delegated pointerup (touch) ->', a.getAttribute('data-page'));
                        const prevActive=document.querySelector('.sidebar-nav li.active'); if(prevActive) prevActive.classList.remove('active'); if(a.parentElement) a.parentElement.classList.add('active'); showPage(a.getAttribute('data-page')); } } });
        } else {
            console.warn('[admin] sidebar element not found on page');
        }

        (function(){const e=localStorage.getItem("meToMilletsProducts");if(e)try{const t=JSON.parse(e);if(!Array.isArray(t)||0===t.length)return void localStorage.removeItem("meToMilletsProducts");window.productData.products=t}catch(e){console.warn("Invalid meToMilletsProducts in localStorage, resetting.",e),localStorage.removeItem("meToMilletsProducts")}}(),$(),function(){const e=window.productData.products,t=window.productData.categoriesConfig,n=document.getElementById("productCategory");n.innerHTML='<option value="">-- Select Category --</option>',t.forEach(e=>{if(e.id&&e.name){const t=document.createElement("option");t.value=e.id,t.textContent=e.name,n.appendChild(t)}});const o=document.getElementById("subcategory"),d=[...new Set(e.map(e=>e.subcategory).filter(Boolean))];o.innerHTML='<option value="">-- Select Subcategory --</option>',d.sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.charAt(0).toUpperCase()+e.slice(1),o.appendChild(t)});const a=document.getElementById("origin"),i=[...new Set(e.map(e=>e.origin).filter(Boolean))];a.innerHTML='<option value="">-- Select Origin --</option>',i.sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})}()});