const serviceId="service_d9vke5o",templateId="template_i17u7ck",userId="Tvwaw5vFMMXDUl7-Z",myEmail="metomillets@gmail.com";const DEBUG_EMAILJS = (typeof localStorage !== 'undefined' && localStorage.getItem && localStorage.getItem('mtm_emailjs_debug') === '1');document.addEventListener("DOMContentLoaded",()=>{if(window.emailjs&&"function"==typeof window.emailjs.init)try{emailjs.init(userId)}catch(t){console.warn("EmailJS init failed:",t)}const t=t=>document.getElementById(t),e=window.utils.formatPrice,n=t("checkoutForm"),i=t("previewPanel"),o=t("previewContent"),r=t("previewOrderBtn"),a=t("editOrderBtn"),d=t("sendOrderBtn"),s=t("resultPanel"),l=t("resultMessage"),c=t("retryActions"),p=t("retryBtn"),m=t("cancelBtn"),u=t("spinner"),g=t("orderSummary"),h=t("subtotal"),b=t("shipping"),y=t("tax"),x=t("grandTotal");let f=0;const v={WELCOME10:.1,CHOCO15:.15,SUMMER20:.2};
    // Merge locally generated referral promos (if any)
    try{
        const localPromos = window.utils.loadFromLocalStorage('referralPromos') || {};
        // ensure values are numbers
        Object.keys(localPromos).forEach(k=>{ if(typeof localPromos[k] === 'string') localPromos[k] = parseFloat(localPromos[k]); });
        Object.assign(v, localPromos);
    }catch(e){console.warn('Failed to load local promos', e);}    

    // Remove legacy autoReferralCode if present (cleanup)
    try{ if (localStorage.getItem('autoReferralCode')) { console.info('Removing legacy autoReferralCode'); localStorage.removeItem('autoReferralCode'); } }catch(e){}
    // Automatic apply of stored referral codes removed to avoid unexpected behaviorlet w=!1;function $(){return window.cartManager&&Array.isArray(window.cartManager.cart)?window.cartManager.cart:window.utils.loadFromLocalStorage("meToMilletsCart")||[]}function C(t){const e=t.reduce((t,e)=>t+(e.price||0)*(e.quantity||1),0),n=e>=299||0===e?0:50,i=e+n,o=+(i*f).toFixed(2);return{subtotal:e,shipping:n,discount:o,taxBefore:0,total:+(+(i-o).toFixed(2)).toFixed(2)}}function E(){const t=$();if(g.innerHTML="",!t||0===t.length)return g.innerHTML='<div class="empty">Your cart is empty</div>',h.textContent=e(0),b.textContent=e(0),y&&(y.textContent=e(0)),void(x.textContent=e(0));t.forEach(t=>{const n=document.createElement("div");n.className="order-item";const i=document.createElement("img");i.src=t.image||"images/products/default.png",i.alt=t.name||"";const o=document.createElement("div");o.className="meta";const r=document.createElement("div");r.className="name",r.textContent=t.name;const a=document.createElement("div");a.className="qtyPrice",a.textContent=`${t.quantity} × ${e(t.price)}`,o.appendChild(r),o.appendChild(a);const d=document.createElement("div");d.className="line",d.textContent=e((t.price||0)*(t.quantity||1)),n.appendChild(i),n.appendChild(o),n.appendChild(d),g.appendChild(n)});const n=C(t);if(h.textContent=e(n.subtotal),b.textContent=0===n.shipping?"Free":e(n.shipping),y&&(y.textContent=e(n.taxBefore)),f>0){const t=document.createElement("div");t.style.cssText="display:flex;justify-content:space-between;color:#d4af37;font-weight:700;margin-top:0.5rem",t.innerHTML=`<span>Discount (-${(100*f).toFixed(0)}%)</span><span>-${e(n.discount)}</span>`,x.parentElement.insertBefore(t,x.parentElement.lastChild)}x.textContent=e(n.total),function(t){if(w)return;if(!t||"object"!=typeof t)return;if(!(t.subtotal>0&&t.shipping>0))return;w=!0;const e=document.createElement("div");e.className="startup-notice-overlay",e.id="deliveryChargeOverlay",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-label","Delivery Charges Notice"),e.innerHTML='\n      <div class="startup-notice-modal" role="document">\n        <button class="startup-notice-close" type="button" aria-label="Close notice">&times;</button>\n        <h3 class="startup-notice-title">Delivery Charges</h3>\n        <p class="startup-notice-text">There are delivery charges for orders less than ₹299.</p>\n        <div class="preview-actions" style="justify-content: space-between;">\n          <button type="button" class="btn btn-secondary" id="addMoreItemsBtn">Add More Items</button>\n          <button type="button" class="btn btn-primary" id="continueCheckoutBtn">Continue</button>\n        </div>\n      </div>\n    ',document.body.appendChild(e);const n=()=>e.remove();e.querySelector(".startup-notice-close")?.addEventListener("click",n),e.addEventListener("click",t=>{t.target===e&&n()});const i=document.getElementById("addMoreItemsBtn"),o=document.getElementById("continueCheckoutBtn");i?.addEventListener("click",()=>{window.location.href="products.html"}),o?.addEventListener("click",n)}(n)}function M(){return{fullName:t("fullName").value.trim(),email:t("email").value.trim(),phone:t("phone").value.trim(),shippingAddress:t("shippingAddress").value.trim(),instructions:t("instructions").value.trim()}}function k(t){return t.fullName?t.email&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.email)?t.phone?t.shippingAddress?null:"Shipping address is required.":"Phone number is required.":"A valid email is required.":"Full name is required."}function S(t){return String(t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function T(t,n,i){const o=`ORD-${Date.now()}`,r=(new Date).toLocaleString(),a=n.map(t=>{const n=(t.price||0)*(t.quantity||1);return`\n        <tr style="border-bottom:1px solid #e9e0da">\n          <td style="padding:12px;text-align:center;color:#3d2b2b"><strong>${t.quantity}</strong></td>\n          <td style="padding:12px;color:#3d2b2b">${S(t.name)}</td>\n          <td style="padding:12px;text-align:right;color:#3d2b2b">${e(t.price||0)}</td>\n          <td style="padding:12px;text-align:right;color:#3d2b2b;font-weight:700">${e(n)}</td>\n        </tr>\n      `}).join("");return`\n      <div style="font-family:'Arial', sans-serif;color:#2b1f1f;background:#f5f0eb;padding:20px;margin:0">\n        <div style="max-width:700px;margin:0 auto;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);">\n          \n          \x3c!-- Header --\x3e\n          <div style="background:linear-gradient(135deg,#3d2b2b,#5a3a39);color:#fff;padding:24px 20px;text-align:center">\n            <h1 style="margin:0;font-size:28px;font-weight:700">Order Confirmation</h1>\n            <p style="margin:6px 0 0 0;color:#f6e7a9;font-size:14px">Me To Millets — Handcrafted Chocolates</p>\n          </div>\n\n          \x3c!-- Order Info Bar --\x3e\n          <div style="background:#f8f3ee;padding:14px 20px;border-bottom:2px solid #e9e0da;display:flex;justify-content:space-between;align-items:center">\n            <div><strong style="color:#3d2b2b">Order ID:</strong> <span style="color:#6b4d3a">${o}</span></div>\n            <div><strong style="color:#3d2b2b">Date:</strong> <span style="color:#6b4d3a">${r}</span></div>\n          </div>\n\n          \x3c!-- Content --\x3e\n          <div style="padding:24px 20px">\n            \n            \x3c!-- Customer Section --\x3e\n            <div style="margin-bottom:24px">\n              <h3 style="margin:0 0 12px 0;color:#3d2b2b;font-size:16px;border-bottom:2px solid #d4af37;padding-bottom:8px">Delivery To</h3>\n              <div style="color:#3d2b2b;line-height:1.8">\n                <strong>${S(t.fullName)}</strong><br>\n                ${S(t.phone)}<br>\n                ${S(t.email)}<br>\n                <div style="margin-top:8px;color:#6b4d3a">${S(t.shippingAddress).replace(/\n/g,"<br>")}</div>\n              </div>\n            </div>\n\n            \x3c!-- Items Section --\x3e\n            <div style="margin-bottom:24px">\n              <h3 style="margin:0 0 12px 0;color:#3d2b2b;font-size:16px;border-bottom:2px solid #d4af37;padding-bottom:8px">Order Items</h3>\n              <table style="width:100%;border-collapse:collapse;margin-bottom:12px">\n                <thead>\n                  <tr style="background:#f8f3ee;border-bottom:2px solid #e9e0da">\n                    <th style="padding:10px;text-align:center;color:#3d2b2b;font-weight:700">Qty</th>\n                    <th style="padding:10px;text-align:left;color:#3d2b2b;font-weight:700">Product</th>\n                    <th style="padding:10px;text-align:right;color:#3d2b2b;font-weight:700">Price</th>\n                    <th style="padding:10px;text-align:right;color:#3d2b2b;font-weight:700">Total</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${a}\n                </tbody>\n              </table>\n            </div>\n\n            \x3c!-- Special Instructions --\x3e\n            ${t.instructions?`\n              <div style="margin-bottom:24px;background:#f8f3ee;padding:12px;border-radius:6px;border-left:4px solid #d4af37">\n                <strong style="color:#3d2b2b">Special Instructions:</strong><br>\n                <span style="color:#6b4d3a">${S(t.instructions)}</span>\n              </div>\n            `:""}\n\n            \x3c!-- Totals Section --\x3e\n            <div style="background:#f8f3ee;padding:16px;border-radius:8px;margin-top:20px">\n              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e9e0da">\n                <span style="color:#3d2b2b">Subtotal</span>\n                <span style="color:#3d2b2b">${e(i.subtotal)}</span>\n              </div>\n              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e9e0da">\n                <span style="color:#3d2b2b">Shipping</span>\n                <span style="color:#3d2b2b">${0===i.shipping?"Free":e(i.shipping)}</span>\n              </div>\n              <div style="display:flex;justify-content:space-between;padding:12px 0;margin-top:8px;border-top:2px solid #d4af37;font-weight:700;font-size:18px;color:#3d2b2b">\n                <span>Grand Total</span>\n                <span style="color:#d4af37">${e(i.total)}</span>\n              </div>\n            </div>\n\n            \x3c!-- Footer Message --\x3e\n            <div style="margin-top:24px;padding-top:20px;border-top:1px solid #e9e0da;text-align:center;color:#6b4d3a;font-size:13px">\n              <p style="margin:0 0 8px 0">Thank you for your order! We'll be in touch soon with shipping details.</p>\n              <p style="margin:0">Questions? Reply to this email or contact us anytime.</p>\n            </div>\n          </div>\n\n          \x3c!-- Footer --\x3e\n          <div style="background:#3d2b2b;color:#fff;padding:16px 20px;text-align:center;font-size:12px">\n            <p style="margin:0">© ${(new Date).getFullYear()} Me To Millets — Handcrafted Chocolates</p>\n            <p style="margin:6px 0 0 0;color:#f6e7a9">www.metomillets.com</p>\n          </div>\n        </div>\n      </div>\n    `}function D(t){u.hidden=!t,u.setAttribute("aria-hidden",(!t).toString())}function I(t,e){s.hidden=!1,l.innerHTML=t,l.style.color=e?"var(--error)":"var(--success)"}r.addEventListener("click",t=>{t.preventDefault(),console.log("Preview button clicked");const n=M(),r=k(n);if(r)return void alert(r);const a=$();if(a&&0!==a.length)try{const t=C(a);o.innerHTML=function(t,n,i){const o=n.map(t=>`\n      <tr style="border-bottom:1px solid #eee">\n        <td style="padding:8px"><img src="${t.image||"https://via.placeholder.com/60"}" width="60" height="60" style="object-fit:cover;border-radius:6px"></td>\n        <td style="padding:8px">${S(t.name)}</td>\n        <td style="padding:8px;text-align:center">${t.quantity}</td>\n        <td style="padding:8px;text-align:right">${e((t.price||0)*(t.quantity||1))}</td>\n      </tr>\n    `).join("");return`\n      <div>\n        <h4>Customer</h4>\n        <div><strong>${S(t.fullName)}</strong> — ${S(t.email)} — ${S(t.phone)}</div>\n        <div style="margin-top:6px">${S(t.shippingAddress).replace(/\n/g,"<br>")}</div>\n        ${t.instructions?`<div style="margin-top:6px;font-style:italic">Notes: ${S(t.instructions)}</div>`:""}\n\n        <h4 style="margin-top:12px">Items</h4>\n        <table style="width:100%;border-collapse:collapse">${o}</table>\n\n        <div style="margin-top:12px">\n          <div><strong>Subtotal:</strong> ${e(i.subtotal)}</div>\n          <div><strong>Shipping:</strong> ${0===i.shipping?"Free":e(i.shipping)}</div>\n          ${i.discount>0?`<div><strong>Discount:</strong> -${e(i.discount)}</div>`:""}\n          <div style="font-weight:700;margin-top:6px">Grand Total: ${e(i.total)}</div>\n        </div>\n      </div>\n    `}(n,a,t),i.hidden = !1;
            const payBtnEl = document.getElementById('sendOrderBtn');
            if (payBtnEl && typeof payBtnEl.scrollIntoView === 'function') {
              payBtnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          } catch (t) { console.error("Preview error:", t), alert("Error generating preview. Please try again.") } else alert("Your cart is empty. Please add items before preview.")}),a.addEventListener("click",()=>{i.hidden=!0,s.hidden=!0}),d.addEventListener("click",async()=>{const t=M(),o=k(t);if(o)return void window.utils.showNotification(o,"error");const r=$();if(!r||0===r.length)return void window.utils.showNotification("Your cart is empty.","error");const a=C(r);D(!0),d.disabled=!0;try{await async function(t,n,i){const o=n.map(t=>`${t.name} - Qty: ${t.quantity} x ${e(t.price)} = ${e((t.price||0)*(t.quantity||1))}`).join("\n"),r=`\nNEW ORDER RECEIVED\n\nORDER ID: ORD-${Date.now()}\nORDER DATE: ${(new Date).toLocaleString()}\n\nCUSTOMER INFORMATION:\nName: ${t.fullName}\nEmail: ${t.email}\nPhone: ${t.phone}\nAddress: ${t.shippingAddress}\n${t.instructions?`Special Instructions: ${t.instructions}`:""}\n\nORDER ITEMS:\n${o}\n\nORDER SUMMARY:\nSubtotal: ${e(i.subtotal)}\nShipping: ${0===i.shipping?"Free":e(i.shipping)}\nGRAND TOTAL: ${e(i.total)}\n\n---\nThis is an automated order notification from Me To Millets.\n    `.trim(),a={to_email:myEmail,from_name:t.fullName,from_email:t.email,customer_name:t.fullName,customer_email:t.email,customer_phone:t.phone,shipping_address:t.shippingAddress,order_items:o,order_total:e(i.total),message:r,html_message:T(t,n,i)};if(!window.emailjs||"function"!=typeof window.emailjs.send)throw new Error("EmailJS SDK not available. Check your network or include the EmailJS script.");
          return emailjs.send(serviceId,templateId,a)
            .then(res => {
              console.info('EMAILJS SEND OK', res, 'params', a);
              if (DEBUG_EMAILJS) {
                try { I(`<strong>EmailJS response:</strong><pre style="white-space:pre-wrap;max-height:160px;overflow:auto">${S(JSON.stringify(res))}</pre>`, false); } catch(e){}
              }
              try{
                emailjs.send(serviceId, templateId, Object.assign({}, a, { to_email: 'metomillets@gmail.com' }))
                  .then(ownerRes => { if (DEBUG_EMAILJS) console.info('Owner copy response', ownerRes); })
                  .catch(ownerErr => { console.warn('Owner copy err', ownerErr); if (DEBUG_EMAILJS) { try { I(`<strong>Owner copy error:</strong><div>${S(String(ownerErr && (ownerErr.text || ownerErr.message) || ownerErr))}</div>`, true); } catch(e){} } });
              }catch(err){ console.warn('Owner copy send failed', err); }
              return ({ok:!0,res:res});
            })
            .catch(err => { console.error('EMAILJS SEND ERROR', err, 'params', a); I(`<strong>EmailJS error</strong><div>${S(String(err && (err.text || err.message) || err))}</div><pre style="white-space:pre-wrap;max-height:160px;overflow:auto">${S(JSON.stringify(err && (err.response || err) || err))}</pre>`, true); throw err; })}(t,r,a);const o=window.utils.loadFromLocalStorage("orders")||[],s={id:`ORD-${Date.now()}`,createdAt:(new Date).toISOString(),customer:t,items:JSON.parse(JSON.stringify(r)),subtotal:a.subtotal,shipping:a.shipping,tax:0,total:a.total,status:"pending",emailSent:!0};o.push(s),window.utils.saveToLocalStorage("orders",o),window.cartManager&&"function"==typeof window.cartManager.clearCart?(window.cartManager.clearCart(),window.cartManager.renderCartItems(),window.cartManager.updateCartCount()):window.utils.saveToLocalStorage("meToMilletsCart",[]),D(!1),d.disabled=!1,i.hidden=!0,n.hidden=!0,I("<strong>Order sent!</strong><div>Check your email for confirmation. Thank you!</div>",!1),window.utils.showNotification("Order sent! Check your email for confirmation","success")}catch(t){console.error("Order send failed:",t),D(!1),d.disabled=!1,I(`<strong>Failed to send order.</strong><div>${S(t&&t.text?t.text:t&&t.message||"Unknown error")}</div>`,!0),c.hidden=!1}}),p.addEventListener("click",()=>{c.hidden=!0,s.hidden=!0,i.hidden=!1}),m.addEventListener("click",()=>{c.hidden=!0,s.hidden=!0,i.hidden=!0});const O=t("promoCode"),L=t("applyPromoBtn"),N=t("promoMessage");L&&L.addEventListener("click",async t=>{t.preventDefault();const e=O.value.toUpperCase().trim();if(!e)return N.textContent="Enter a promo code",N.style.background="#fee",N.style.color="#c33",N.hidden=!1,void(f=0);v[e]?(f=v[e],N.textContent=`✓ Promo applied! ${(100*f).toFixed(0)}% discount`,N.style.background="#efe",N.style.color="#2e8b57",N.hidden=!1,window.utils.showNotification(`Promo "${e}" applied!`,"success"),E()):(N.textContent="Invalid promo code",N.style.background="#fee",N.style.color="#c33",N.hidden=!1,f=0,E())}),E(),window.addEventListener("storage",t=>{"meToMilletsCart"===t.key&&E()});const A=document.getElementById("currentYear");A&&(A.textContent=(new Date).getFullYear())});