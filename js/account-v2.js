document.addEventListener("DOMContentLoaded",()=>{if(!document.querySelector(".account-page"))return;const e=(e,t)=>{window.utils.showNotification(e,t),setTimeout(()=>{window.location.href="login-register.html"},1e3)},t=document.querySelectorAll(".account-menu a"),n=document.querySelectorAll(".account-section"),s=document.getElementById("accountSidebar"),a=document.getElementById("accountNavToggle"),o=document.getElementById("accountCurrentTab"),i=e=>{s&&(s.classList.toggle("is-open",!!e),a&&a.setAttribute("aria-expanded",e?"true":"false"))};a&&s&&a.addEventListener("click",()=>{const e=!s.classList.contains("is-open");i(e)}),t.forEach(e=>{e.addEventListener("click",s=>{const a=e.dataset.section;a&&(s.preventDefault(),(e=>{if(n.forEach(t=>{t.id===e?t.classList.add("active"):t.classList.remove("active")}),t.forEach(t=>{t.classList.toggle("active",t.dataset.section===e)}),o){const n=Array.from(t).find(t=>t.dataset.section===e);n&&(o.textContent=n.textContent.replace(/\s+/g," ").trim())}})(a),window.matchMedia&&window.matchMedia("(max-width: 768px)").matches&&(i(!1),document.querySelector(".account-main")?.scrollIntoView({block:"start"})))})});const r=document.getElementById("logoutBtn");function d(){const e=document.getElementById("subscriptionsList"),t=document.getElementById("noSubscriptions");if(!e||!window.subscriptionManager)return;const n=window.subscriptionManager.subscriptions||[];if(0===n.length)return e.innerHTML="",void(t&&(t.style.display="block"));t&&(t.style.display="none");let s="";n.forEach(e=>{s+=`\n                <div class="subscription-card">\n                    <div class="subscription-header">\n                        <div>\n                            <strong>${e.name}</strong>\n                            <div>Next delivery: ${e.nextDelivery}</div>\n                        </div>\n                        <div class="subscription-actions">\n                            ${"active"===e.status?`<button class="btn btn-secondary pause-sub" data-id="${e.id}">Pause</button>`:`<button class="btn btn-primary resume-sub" data-id="${e.id}">Resume</button>`}\n                            <button class="btn btn-danger cancel-sub" data-id="${e.id}">Cancel</button>\n                        </div>\n                    </div>\n                    <div><small>Frequency: every ${e.frequency} week(s)</small></div>\n                </div>\n            `}),e.innerHTML=s,e.querySelectorAll(".pause-sub").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.id);window.subscriptionManager.pauseSubscription(t,2),d(),window.utils.showNotification("Subscription paused","info")})}),e.querySelectorAll(".resume-sub").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.id);window.subscriptionManager.resumeSubscription(t),d(),window.utils.showNotification("Subscription resumed","success")})}),e.querySelectorAll(".cancel-sub").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.id);window.subscriptionManager.cancelSubscription(t),d(),window.utils.showNotification("Subscription cancelled","warning")})})}function c(){const e=document.getElementById("addressesList"),t=document.getElementById("noAddresses");if(!e)return;const n=window.utils.loadFromLocalStorage("addresses")||[];if(0===n.length)return e.innerHTML="",void(t&&(t.style.display="block"));t&&(t.style.display="none");let s="";n.forEach((e,t)=>{s+=`\n                <div class="address-card">\n                    <div class="address-actions">\n                        <button class="btn btn-secondary edit-address" data-idx="${t}"><i class="fas fa-edit"></i></button>\n                        <button class="btn btn-danger remove-address" data-idx="${t}"><i class="fas fa-trash"></i></button>\n                    </div>\n                    <h4>${e.name}</h4>\n                    <div>${e.street}</div>\n                    <div>${e.city}, ${e.state} ${e.zip}</div>\n                    ${e.default?'<div class="address-default">Default</div>':""}\n                </div>\n            `}),e.innerHTML=s,e.querySelectorAll(".remove-address").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.idx),n=(window.utils.loadFromLocalStorage("addresses")||[]).slice();n.splice(t,1),window.utils.saveToLocalStorage("addresses",n),c(),window.utils.showNotification("Address removed","info")})}),e.querySelectorAll(".edit-address").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.idx),n=(window.utils.loadFromLocalStorage("addresses")||[]).slice(),s=n[t];if(!s)return;const a=prompt("Name",s.name)||s.name,o=prompt("Street",s.street)||s.street,i=prompt("City",s.city)||s.city,r=prompt("State",s.state)||s.state,d=prompt("ZIP",s.zip)||s.zip;n[t]={...s,name:a,street:o,city:i,state:r,zip:d},window.utils.saveToLocalStorage("addresses",n),c(),window.utils.showNotification("Address updated","success")})})}r&&r.addEventListener("click",e=>{e.preventDefault(),(async()=>{try{window.authClient&&await window.authClient.logout()}catch{}finally{localStorage.removeItem("isUserLoggedIn"),localStorage.removeItem("userProfile"),window.utils.showNotification("You have been logged out","info"),setTimeout(()=>location.href="../index.html",800)}})()});const l=document.getElementById("addAddressBtn");l&&l.addEventListener("click",()=>{const e=prompt("Full name");if(!e)return;const t=prompt("Street address"),n=prompt("City"),s=prompt("State"),a=prompt("ZIP"),o=window.utils.loadFromLocalStorage("addresses")||[];o.push({name:e,street:t,city:n,state:s,zip:a,default:0===o.length}),window.utils.saveToLocalStorage("addresses",o),c(),window.utils.showNotification("Address added","success")});const u=document.getElementById("changePasswordForm");u&&u.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("newPassword").value.trim(),n=document.getElementById("confirmPassword").value.trim();!t||t.length<6?window.utils.showNotification("Password should be at least 6 characters","warning"):t===n?(window.utils.showNotification("Password changed successfully","success"),u.reset()):window.utils.showNotification("New passwords do not match","error")});const m=document.getElementById("savePreferences");m&&m.addEventListener("click",e=>{e.preventDefault(),window.utils.showNotification("Preferences saved","success")}),(async()=>{if(!window.authClient)return void e("Auth system not loaded. Please log in again.","error");try{const{user:e}=await window.authClient.me();window.utils.saveToLocalStorage("isUserLoggedIn",!0),window.utils.saveToLocalStorage("userProfile",{name:e?.name||"Valued Customer",email:e?.email||"",joined:e?.createdAt||(new Date).toISOString()})}catch{return localStorage.removeItem("isUserLoggedIn"),localStorage.removeItem("userProfile"),void e("Please log in to access your account.","warning")}const t=window.utils.loadFromLocalStorage("userProfile")||{name:"Valued Customer",email:"",joined:(new Date).toISOString()},n=document.getElementById("userName"),s=document.getElementById("userInitials"),a=document.getElementById("memberSince");n&&(n.textContent=t.name),s&&(s.textContent=(t.name||"U").split(" ").map(e=>e[0]).slice(0,2).join("").toUpperCase()),a&&(a.textContent=new Date(t.joined||t.createdAt||Date.now()).getFullYear());const o=await async function(){if(!window.mtmApi||"function"!=typeof window.mtmApi.request)return null;try{await window.mtmApi.request("GET","/api/auth/me");const e=await window.mtmApi.request("GET","/api/orders/mine");return(Array.isArray(e?.orders)?e.orders:[]).map(e=>({...e,id:e.orderNumber||e.id,date:e.date||e.createdAt,items:Array.isArray(e.items)?e.items:[]}))}catch(e){return null}}()||window.utils.loadFromLocalStorage("orders")||[];!function(e){const t=window.utils.loadFromLocalStorage("tastingJournal")||[],n=document.getElementById("totalOrders"),s=document.getElementById("wishlistCountStat"),a=document.getElementById("avgRating"),o=document.getElementById("tastingsCount");if(n&&(n.textContent=e.length),o&&(o.textContent=t.length),a){const e=t.map(e=>e.rating).filter(e=>"number"==typeof e),n=e.length?e.reduce((e,t)=>e+t,0)/e.length:0;a.textContent=n?n.toFixed(1):"0.0"}s&&window.cartManager&&(s.textContent=window.cartManager.getWishlistCount())}(o),function(e){const t=document.getElementById("recentOrders"),n=document.getElementById("ordersTableBody"),s=document.getElementById("noOrders");if(t&&(0===e.length?t.innerHTML='<div class="empty-state"><i class="fas fa-shopping-bag"></i><p>No recent orders</p></div>':(t.innerHTML="",e.slice(-3).reverse().forEach(e=>{const n=document.createElement("div");n.className="order-summary";const s=e.date||e.createdAt||Date.now(),a=Array.isArray(e.items)?e.items.length:e.itemsCount||0;n.innerHTML=`\n                        <strong>Order #${e.id}</strong>\n                        <div>${new Date(s).toLocaleDateString()}</div>\n                        <div>${a} items ‚Äî ${window.utils.formatPrice(e.total)}</div>\n                    `,t.appendChild(n)}))),n)if(0===e.length)n.innerHTML="",s&&(s.style.display="block");else{s&&(s.style.display="none");let t="";e.forEach(e=>{const n=e.date||e.createdAt||Date.now(),s=Array.isArray(e.items)?e.items.length:e.itemsCount||0;t+=`\n                        <tr>\n                            <td>#${e.id}</td>\n                            <td>${new Date(n).toLocaleDateString()}</td>\n                            <td>${s}</td>\n                            <td>${window.utils.formatPrice(e.total)}</td>\n                            <td><span class="order-status ${"delivered"===e.status?"status-delivered":"processing"===e.status?"status-processing":"status-pending"}">${e.status}</span></td>\n                        </tr>\n                    `}),n.innerHTML=t}}(o),window.cartManager&&window.cartManager.renderWishlistItems("#accountWishlistItems"),function(){const e=window.utils.loadFromLocalStorage("tastingJournal")||[],t=document.getElementById("journalSummary");if(!t)return;if(0===e.length)return void(t.innerHTML='<div class="empty-state"><i class="fas fa-book"></i><p>No tastings logged yet</p><a href="tasting-journal.html" class="btn btn-primary">Start Tasting</a></div>');let n='<div class="recommendations-grid">';e.slice(-4).reverse().forEach(e=>{n+=`\n                <div class="recommendation-card">\n                    <div class="rec-content">\n                        <h4 class="rec-title">${e.productName||"Unknown"}</h4>\n                        <div class="rec-match">Rating: ${e.rating||"‚Äî"}</div>\n                        <p class="rec-description">${e.notes||""}</p>\n                    </div>\n                </div>\n            `}),n+="</div>",t.innerHTML=n}(),function(){const e=document.getElementById("preferencesGrid"),t=document.getElementById("overviewPreferences"),n=window.utils.loadFromLocalStorage("userPreferences")||[];e&&(e.innerHTML="",["Less Sweet","Moderate","Sweet","Smooth","Crunchy","Chewy","Dark","Gifting"].forEach(t=>{const s=document.createElement("div");s.className="preference-card",s.innerHTML=`\n                <div class="preference-icon">üç´</div>\n                <h4>${t}</h4>\n                <div class="flavor-tags">\n                    <button class="btn preference-toggle ${n.includes(t)?"active":""}" data-tag="${t}">${n.includes(t)?"Selected":"Select"}</button>\n                </div>\n            `,e.appendChild(s)}),t&&(t.innerHTML=n.map(e=>`<span class="rec-match">${e}</span>`).join(" ")),document.querySelectorAll(".preference-toggle").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.tag;let s=window.utils.loadFromLocalStorage("userPreferences")||[];s.includes(n)?(s=s.filter(e=>e!==n),e.classList.remove("active"),e.textContent="Select"):(s.push(n),e.classList.add("active"),e.textContent="Selected"),window.utils.saveToLocalStorage("userPreferences",s),t&&(t.innerHTML=s.map(e=>`<span class="rec-match">${e}</span>`).join(" "))})}))}(),d(),c()})();const w=document.getElementById("currentYear");w&&(w.textContent=(new Date).getFullYear())});